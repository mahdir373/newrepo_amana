# ×©×œ×‘ 1: Build â€“ × ×‘× ×” ××ª ×”××¤×œ×™×§×¦×™×”
FROM node:18-alpine AS build

# ×ª×§×™×™×ª ×”×¢×‘×•×“×” ×‘×ª×•×š ×”×§×•× ×˜×™×™× ×¨
WORKDIR /app

# ×¨×§ ×§×‘×¦×™ ×”- package ×›×“×™ ×œ× ×¦×œ cache
COPY package*.json ./

# ×”×ª×§× ×ª ×—×‘×™×œ×•×ª
RUN npm install

# ×”×¢×ª×§×ª ×©××¨ ×§×‘×¦×™ ×”×¤×¨×•×™×§×˜
COPY . .

# ×‘× ×™×™×ª ×’×¨×¡×” ×œ-production
RUN npm run build

# ×©×œ×‘ 2: Serve â€“ × ×’×™×© ××ª ×”×§×‘×¦×™× ×“×¨×š NGINX
FROM nginx:alpine

# ××—×™×§×ª ×§×•×‘×¥ ×‘×¨×™×¨×ª ×”××—×“×œ ×©×œ nginx
RUN rm -rf /usr/share/nginx/html/*

# ×”×¢×ª×§×ª ×”-build ×œ-nginx
COPY --from=build /app/build /usr/share/nginx/html

# ğŸ”¹ ×œ×’×¨×•× ×œ-Nginx ×œ×”×§×©×™×‘ ×¢×œ ×¤×•×¨×˜ 8080 (××” ×©-Cloud Run ××¦×¤×” ×œ×•)
RUN sed -i 's/listen       80;/listen       8080;/' /etc/nginx/conf.d/default.conf

# ×¤×ª×™×—×ª ×¤×•×¨×˜ 8080 (Cloud Run ××©×ª××© ×‘-PORT=8080)
EXPOSE 8080

# ×”×¨×¦×ª nginx
CMD ["nginx", "-g", "daemon off;"]
